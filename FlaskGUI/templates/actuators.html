<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draggable Buttons</title>
    <style>
        body{
            /*makes everything unselectable, DO NOT REMOVE, buttons will drag while locked if selected, I do not know why :(*/
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #messageContainer{
            position: absolute;
            left: 25vh;
            text-align: left;
            width: 15vw;
            font-weight: bold;
        }
        #backgroundContainer {
            z-index:-1;
            height: calc(100vh - 25px);
            width: 100vw;
            position: fixed;
            margin-top: 1%;    

            background-image: url("{{ url_for('static', filename='HTS_PandID.png') }}");
            background-size: contain; 
            background-repeat: no-repeat;
            background-origin: content-box;
            background-position: center center;

            transform: translateY(25px);
        }
        .collapsible-menu label {
            display: block;
            cursor: pointer;
            background-color: antiquewhite;
            text-align: center;
            font-weight: bold;
            width: 10vw;
            padding: 0 10px 5px 10px;
        }
        input#menu {
            display: none;
        }
        .guiControlButtonsContainer {
            width: 10vw;
            max-height: 0;
            overflow: hidden;
            padding: 0 10px 0 10px;
            background-color:antiquewhite;
            cursor: pointer;
            align-items: center;
        }
        #guiControlButtons{
            position: relative;
            width: 10vw;
            padding: 10px 10px;
            margin-bottom: 10px;
        }
        input:checked ~ .guiControlButtonsContainer {
            max-height: 100%;
        }
        .draggable {
            width: 60px;
            position: absolute;
            cursor: move;
            pointer-events: auto;
            background-color:black;
            border: none;
            align-items: center;
        }
        .input.radio {display: inline-block;}
        .toggleOn{
            position : relative ;
            display : inline-block;
            width : 30px;
            height : 20x;
            background-color: white;
            text-align: center;
        }
        .toggleOff{
            position : relative ;
            display : inline-block;
            width : 30px;
            height : 20x;
            background-color: white;
            text-align: center;
        }
        .checkbox:checked + .toggleOff{
            background-color: lightcoral;
        }
        .checkbox:checked + .toggleOn{
            background-color: lightgreen;
        }

        /* Checkbox vanished */
        .checkbox {
            display: none;
        }
        #buttonName{
            position: relative;
            color: white;
            text-align: center;
        }
        .locked {
            cursor: pointer;
        }
        
    </style>
</head>
<body>
<form method="post">
    {% for button in actuator_buttons %}
        
        </label>
        <div id="{{ button }}" class="draggable" draggable="true">
            <legend id="buttonName">{{button[5]}}</legend>
            <input type="radio" id="{{ button[5] }} OFF" name="{{ button }}" class="checkbox"  onclick="buttonClicked(id)"/><label for="{{ button[5] }} OFF" class="toggleOff">OFF</label><input type="radio" id="{{ button[5] }} ON" name="{{ button }}" class="checkbox"  onclick="buttonClicked(id)"/><label for="{{ button[5] }} ON" class="toggleOn">ON</label>
        </div>


    {% endfor %}
</form>


<div id="backgroundContainer"></div>
<div id="messageContainer"></div>
<div class="collapsible-menu">
    <input type="checkbox" id="menu">
    <label for="menu">Menu</label>
    <div class="guiControlButtonsContainer">
        <button id="guiControlButtons" onclick="submitCoordinates()">Submit Coordinates</button>
        <button id="guiControlButtons" onclick="getCoordinates(false)">Get Coordinates</button>
        <button id="guiControlButtons" onclick="lockButtons()">Lock Buttons</button>
        <button id="guiControlButtons" onclick="unlockButtons()">Unlock Buttons</button>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    socket.on('connect', function() {
        //socket.emit('my_event', {data: 'I\'m connected!'});
    });

</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Fetch coordinates when the page is loaded
        getCoordinates(true);

        let draggableElements = document.querySelectorAll('.draggable');
        let isLocked = false;

        // TODO: a proper way of locking cuz running this function is kinda stupid, GPT wrote this and idk how it works
        lockButtons();

        draggableElements.forEach(function (element) {
            element.addEventListener('dragstart', function (e) {
                if (isLocked) {
                    e.preventDefault(); // Prevent dragging when locked
                    return;
                }
                e.dataTransfer.setData('text/plain', element.id);
            });
        });

        document.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        document.addEventListener('drop', function (e) {
            e.preventDefault();
            if (isLocked) {
                return; // Ignore drop when locked
            }
            let data = e.dataTransfer.getData('text/plain');
            let draggedElement = document.getElementById(data);

            let offsetX = e.clientX - draggedElement.offsetWidth / 2;
            let offsetY = e.clientY - draggedElement.offsetHeight / 2;

            draggedElement.style.left = offsetX + 'px';
            draggedElement.style.top = offsetY + 'px';
        });

        // on page load we set every actuator to off
        let buttonlist = document.querySelectorAll('.offButtons');
        buttonlist.forEach(function (element) {
            console.log("button id: ", element.id)
            buttonClicked(element.id);
        });
    });

    function buttonClicked(id){
        // when we unlock buttons we want to ignore any accidental clicks
        if (!isLocked){
            return;
        }
        console.log("right before socket.emit")
        // Replace 'received_actuator_button_press' with your actual event name
        socket.emit('revieved_actuator_button_press', id);
    }


    function submitCoordinates() {
        textprompt="tim hates linux"
            while(true){
            let confirmationPhrase = prompt("Type 'tim hates linux' to confirm");
            if (confirmationPhrase === textprompt) {

                let draggableElements = document.querySelectorAll('.draggable');
                let coordinates = [];

                draggableElements.forEach(function (element) {
                    let rect = element.getBoundingClientRect();
                    coordinates.push({ id: element.id, x: rect.left, y: rect.top });
                });

                // Send coordinates to Flask
                sendDataToFlask(coordinates);
                return;

            } else if (confirmationPhrase === null) {
                return; //user clicked cancel
                
            } else {
                alert("Confirmation failed. Incorrect phrase.");
            }
        }
    }

    function sendDataToFlask(coordinates) {
        fetch('/update_coordinates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ coordinates: coordinates }),
        })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
    }

    function getCoordinates(initial_load) {
        fetch('/get_coordinates')
            .then(response => response.json())
            .then(data => {
                let coordinates = data.coordinates;
                console.log("Coordinates:", coordinates);

                // Place the buttons at the fetched coordinates
                coordinates.forEach(coord => {
                    let button = document.getElementById(coord.id);
                    if (button) {
                        button.style.left = coord.x + 'px';
                        button.style.top = coord.y + 'px';
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }

    function lockButtons() {
        let draggableElements = document.querySelectorAll('.draggable');
        draggableElements.forEach(function (element) {
            element.classList.add('locked');
            element.draggable = false;
        });
        isLocked = true;
        messageContainer.innerText = "Button Positions are LOCKED";
    }

    function unlockButtons() {
        let draggableElements = document.querySelectorAll('.draggable');
        draggableElements.forEach(function (element) {
            element.classList.remove('locked');
            element.draggable = true;
        });
        isLocked = false;
        messageContainer.innerText = "Button Positions are UNLOCKED";
    }
</script>

</body>
</html>
